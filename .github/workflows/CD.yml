name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create .env
        run: |
          echo "PORT=${{secrets.PORT}}" >> .env
          echo "DATABASE_URL=${{secrets.DATABASE_URL}}" >> .env
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Pull image
        run: docker pull ${{ secrets.DOCKERHUB_USERNAME }}/capstone-api-fiverr:latest
      - name: Stop and remove existing container
        run: |
          sudo docker rm -f capstone_api || true
      - name: Run container
        run: |
          sudo docker run -d --name capstone_api --env-file .env -p 3001:3000 ${{ secrets.DOCKERHUB_USERNAME }}/capstone-api-fiverr:latest
      - name: Cleanup env
        run: rm -f .env
